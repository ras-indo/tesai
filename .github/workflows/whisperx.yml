name: Faster-Whisper + Pyannote Diarization

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  diarization:
    runs-on: ubuntu-latest
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: 3.9

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install core dependencies
        run: |
          pip install regex numpy<2 packaging coloredlogs flatbuffers protobuf

      - name: Install PyTorch CPU + torchaudio
        run: |
          pip install torch==2.9.1 torchaudio==2.9.1 --index-url https://download.pytorch.org/whl/cpu

      - name: Install pyannote.audio
        run: |
          pip install pyannote.core==5.0.0 pyannote.audio==4.1.1

      - name: Install Faster Whisper + other deps
        run: |
          pip install faster-whisper librosa==0.10.0 soundfile==0.12.1 \
                      pandas==2.0.3 nltk==3.8.1 scipy==1.11.4 scikit-learn==1.3.2 \
                      tqdm==4.66.1 numba==0.58.1 jiwer==3.0.3 huggingface-hub==0.20.3 \
                      ffmpeg-python==0.2.0 safetensors tokenizers

      - name: Download NLTK punkt
        run: |
          python -m nltk.downloader punkt

      - name: Run Diarization Script
        run: |
          python run_whisperx.py
