name: Faster-Whisper + Pyannote Diarization

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  diarization:
    runs-on: ubuntu-latest
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Upgrade pip, setuptools, wheel
        run: python -m pip install --upgrade pip setuptools wheel

      - name: Install core dependencies (quote specs to avoid shell redirection)
        run: |
          pip install "regex" "packaging" "coloredlogs" "flatbuffers" "protobuf"
          pip install "numpy<2"

      - name: Install PyTorch (CPU) and torchaudio
        run: |
          pip install "torch==2.8.0+cpu" "torchaudio==2.8.0+cpu" --index-url https://download.pytorch.org/whl/cpu

      - name: Install pyannote.audio (use available 4.x) and minimal deps
        run: |
          pip install "pyannote.core==5.0.0"
          pip install "pyannote.audio==4.0.3"
          pip install "asteroid-filterbanks>=0.4" "einops>=0.6.0"

      - name: Install faster-whisper and ONNX runtime (transcription)
        run: |
          pip install "faster-whisper"
          pip install "onnxruntime==1.16.3"

      - name: Install other audio / ML packages
        run: |
          pip install "librosa==0.10.0" "soundfile==0.12.1" "pandas==2.0.3" "scipy==1.11.4" "scikit-learn==1.3.2"
          pip install "tqdm==4.66.1" "numba==0.58.1" "jiwer==3.0.3"
          pip install "huggingface-hub==0.20.3" "ffmpeg-python==0.2.0" "safetensors" "tokenizers"

      - name: Download NLTK punkt (heredoc, robust)
        run: |
          python - <<'PY'
          import nltk
          nltk.download('punkt', quiet=True)
          print("✅ NLTK punkt downloaded")
          PY

      - name: Verify environment (heredoc)
        run: |
          python - <<'PY'
          import traceback
          def check(mod):
              try:
                  m = __import__(mod)
                  v = getattr(m, "__version__", None)
                  print(f"✔ {mod}: {v if v is not None else 'loaded (no __version__)'}")
              except Exception as e:
                  print(f"✖ {mod}: import failed -> {e}")
                  traceback.print_exc()

          for m in ("numpy", "torch", "pyannote.audio", "faster_whisper", "onnxruntime"):
              check(m)
          PY

      - name: Run diarization script (fail if HF_TOKEN missing)
        run: |
          if [ -z "${HF_TOKEN}" ]; then
            echo "ERROR: HF_TOKEN not set. Please add secret HF_TOKEN to repository (Settings → Secrets)."
            exit 1
          fi
          python run_diarization.py

      - name: Upload outputs as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: diarization-results
          path: |
            *_diarized.json
            *_transcript.txt
            *_subtitles.srt