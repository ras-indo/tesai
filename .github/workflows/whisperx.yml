name: Whisper + Pyannote Diarization

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  diarization:
    runs-on: ubuntu-latest
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: 3.10

    - name: Upgrade pip
      run: python -m pip install --upgrade pip

    - name: Install core dependencies
      run: |
        pip install "regex" "packaging" "coloredlogs" "flatbuffers" "protobuf" "numpy<2"

    - name: Install PyTorch CPU
      run: |
        pip install torch==2.1.2 torchaudio==2.1.2 --index-url https://download.pytorch.org/whl/cpu

    - name: Install Pyannote Audio 4.x
      run: |
        pip install "pyannote.core==5.0.0" "pyannote.audio==4.1.1" "asteroid-filterbanks>=0.4" "einops>=0.6.0"

    - name: Install faster-whisper and other ML deps
      run: |
        pip install "faster-whisper==0.3.3" "onnxruntime==1.16.3" "transformers==4.35.2" "pytorch-lightning==2.0.9" "ctranslate2==4.3.1"

    - name: Install other audio / processing packages
      run: |
        pip install "pandas==2.0.3" "nltk==3.8.1" "scipy==1.11.4" "scikit-learn==1.3.2" "librosa==0.10.0" "soundfile==0.12.1" "tqdm==4.66.1" "numba==0.58.1" "jiwer==3.0.3" "huggingface-hub==0.20.3" "ffmpeg-python==0.2.0" "safetensors" "tokenizers"

    - name: Download NLTK data
      run: |
        python -c "import nltk; nltk.download('punkt', quiet=True)"

    - name: Verify Python environment
      run: |
        python -c "import numpy; print('NumPy:', numpy.__version__)"
        python -c "import torch; print('Torch:', torch.__version__)"
        python -c "import pyannote.audio; print('Pyannote.audio loaded')"
        python -c "import faster_whisper; print('faster-whisper loaded')"

    - name: Run diarization script
      run: |
        python run_diarization.py