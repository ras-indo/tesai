name: Audio Transcription & Diarization

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  process-audio:
    runs-on: ubuntu-latest
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install --upgrade pip
          
          # Core ML libraries
          pip install torch torchaudio --index-url https://download.pytorch.org/whl/cpu
          pip install faster-whisper
          pip install pyannote.audio
          pip install numpy<2
          
          # Audio processing
          pip install soundfile librosa

      - name: ğŸµ Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: ğŸš€ Run Processing
        run: |
          if [ -z "${HF_TOKEN}" ]; then
            echo "âš ï¸  HF_TOKEN not set (continuing without diarization)"
          fi
          python run_diarization.py

      - name: ğŸ“¤ Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: transcription-results
          path: |
            *_diarized.json
            *_transcript.txt
            *_subtitles.srt