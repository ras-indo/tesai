name: Whisper + Pyannote Diarization

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  transcribe:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.10]

    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install core dependencies
        run: |
          pip install --upgrade regex packaging coloredlogs flatbuffers protobuf numpy<2

      - name: Install PyTorch CPU
        run: |
          pip install torch==2.8.0+cpu torchaudio==2.8.0+cpu --index-url https://download.pytorch.org/whl/cpu

      - name: Install faster-whisper and Pyannote
        run: |
          pip install faster-whisper==0.9.1
          pip install pyannote.core==5.0.0 pyannote.audio==4.1.1 pyannote.metrics pyannote.database

      - name: Install other requirements
        run: |
          pip install librosa==0.10.0 soundfile==0.12.1 tqdm==4.66.1 pandas==2.0.3 onnxruntime==1.16.3

      - name: Verify dependencies
        run: |
          python -c "import torch, librosa, pyannote.audio, faster_whisper; print('âœ… All core modules imported')"

      - name: Run transcription & diarization
        run: |
          python run_diarization.py