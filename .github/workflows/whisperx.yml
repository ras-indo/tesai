name: Audio Transcription + Diarization

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  transcribe:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install core dependencies
        run: |
          pip install regex packaging coloredlogs flatbuffers protobuf numpy<2

      - name: Install PyTorch CPU compatible
        run: |
          pip install torch==2.8.0+cpu torchaudio==2.8.0+cpu --index-url https://download.pytorch.org/whl/cpu

      - name: Install pyannote.audio (Python 3.9 compatible)
        run: |
          pip install pyannote.core==5.0.0 pyannote.audio==3.4.0

      - name: Install other required packages
        run: |
          pip install pandas==2.0.3 nltk==3.8.1 scipy==1.11.4 scikit-learn==1.3.2 librosa==0.10.0 soundfile==0.12.1 tqdm==4.66.1 numba==0.58.1 \
          jiwer==3.0.3 huggingface-hub==0.20.3 ffmpeg-python==0.2.0 faster-whisper==0.5.2 onnxruntime==1.16.3 ctranslate2==4.3.1 pytorch-lightning==2.0.9

      - name: Download NLTK data
        run: |
          python -c "import nltk; nltk.download('punkt', quiet=True)"

      - name: Setup HF_TOKEN
        run: |
          echo "HF_TOKEN=${{ secrets.HF_TOKEN }}" >> $GITHUB_ENV

      - name: Run transcription + diarization
        run: |
          python run_diarization.py