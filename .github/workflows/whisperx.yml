name: Audio Transcription & Diarization

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  process-audio:
    runs-on: ubuntu-latest
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: ğŸ“¦ Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsndfile1

      - name: ğŸ”§ Install Python Dependencies
        run: |
          pip install --upgrade pip
          # Install compatible PyTorch version
          pip install torch==2.8.0+cpu torchaudio==2.8.0+cpu --index-url https://download.pytorch.org/whl/cpu
          # Install the CORRECT version of pyannote.audio
          pip install pyannote.audio==4.0.3
          # Install other dependencies
          pip install faster-whisper
          pip install "numpy<2.0.0"
          pip install soundfile librosa

      - name: ğŸš€ Run Audio Processing
        run: |
          if [ -z "${HF_TOKEN}" ]; then
            echo "âš ï¸ HF_TOKEN not set (continuing without diarization)"
          fi
          python audio_processor.py

      - name: ğŸ“¤ Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: transcription-results
          path: |
            *_diarized.json
            *_transcript.txt
            *_subtitles.srt
          retention-days: 7