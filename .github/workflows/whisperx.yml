name: Whisper + Pyannote Diarization

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  diarization:
    runs-on: ubuntu-latest
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: 3.10

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install core dependencies
        run: |
          pip install "regex" "packaging" "coloredlogs" "flatbuffers" "protobuf"
          pip install "numpy<2"

      - name: Install PyTorch CPU (needed by pyannote.audio)
        run: |
          pip install torch==2.8.0+cpu torchaudio==2.8.0+cpu --index-url https://download.pytorch.org/whl/cpu

      - name: Install pyannote.audio
        run: |
          pip install "pyannote.core==5.0.0" "pyannote.audio==4.1.1"

      - name: Install faster-whisper (transcription)
        run: |
          pip install "faster-whisper"

      - name: Install other audio & ML dependencies
        run: |
          pip install "librosa==0.10.0" "soundfile==0.12.1" "pandas==2.0.3" "scipy==1.11.4" "scikit-learn==1.3.2" "tqdm==4.66.1"
          pip install "huggingface-hub==0.20.3" "ffmpeg-python==0.2.0" "safetensors" "tokenizers"

      - name: Download NLTK punkt
        run: python - << 'EOF'
          import nltk
          nltk.download('punkt', quiet=True)
        EOF

      - name: Verify environment
        run: |
          python - << 'EOF'
          import torch, numpy, pyannote.audio, faster_whisper
          print("✔ Torch:", torch.__version__)
          print("✔ NumPy:", numpy.__version__)
          print("✔ pyannote.audio and faster-whisper loaded")
          EOF

      - name: Run diarization script
        run: python run_diarization.py